class Chart{constructor(t){this.chart_data=[],this.show_data=[],this.show_start=0,this.show_end=0,this.coords_of_candles=[],this.press=!1,this.last_xmove=!1,this.last_ymove=!1,this.lasttouch_xmove=!1,this.lasttouch_ymove=!1,this.scale=!1,this.touthstart_scrolltop=0,this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.linecolor="#444",this.cursorlinecolor="#aaa",this.growcolor="#bdfa69",this.fallcolor="#e159ab",this.fontcolor="#555",this.loading=!1,this.control(),this.loading_spinner()}update(t,s){clearInterval(this.loading),this.loading=!1,this.chart_data=t,this.currencypair=s,this.show_start=this.chart_data.length-1>30?this.chart_data.length-31:0,this.show_end=this.chart_data.length,this.show_data=this.chart_data.slice(this.show_start,this.show_end),this.draw()}updateLastCandle(t){}control(){let t=t=>{let s=Math.max(-1,Math.min(1,t.wheelDelta||-t.detail));this.scroll(s,t),t.preventDefault()};this.canvas.onmousedown=(()=>{this.press=!0}),this.canvas.onmouseup=(()=>{this.press=!1}),window.onmouseup=(()=>{this.press=!1}),window.onresize=(()=>{this.chart_data.length>0&&this.draw()}),this.canvas.onmousemove=(t=>{this.press?this.pan_event(t):this.mouse_move_event(t)});let s=0,i=0,a=0;this.canvas.ontouchstart=(t=>{s=0,i=0}),this.canvas.ontouchmove=(t=>{if(2===t.changedTouches.length){let h=t.changedTouches[0].screenX,e=t.changedTouches[1].screenX,r=Math.abs(i-s),o=Math.abs(e-h);if(Math.abs(o-r)<3)return!1;a=o>r?1:-1,s=h,i=e}if(1===t.changedTouches.length){let i=t.changedTouches[0].screenX;if(Math.abs(s-i)<3)return!1;this.pan_event(t,!0),s=i}}),this.canvas.addEventListener("mousewheel",t,!1),this.canvas.addEventListener("DOMMouseScroll",t,!1)}loading_spinner(){if(this.loading)return!1;let t=new Date;this.canvas.width=1*this.canvas.parentNode.clientWidth,this.canvas.height=1*this.canvas.parentNode.clientHeight;this.loading=setInterval(()=>{let s=parseInt((new Date-t)/1e3*16)/16;this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.rotate(2*Math.PI*s);for(var i=0;i<16;i++)this.ctx.beginPath(),this.ctx.rotate(2*Math.PI/16),this.ctx.moveTo(100/9,0),this.ctx.lineTo(25,0),this.ctx.lineWidth=2.5,this.ctx.strokeStyle="rgba(90,90,90,"+i/16+")",this.ctx.stroke();this.ctx.restore()},1e3/30)}mouse_move_event(t){if(0===this.chart_data.length)return!1;let[s,i]=this.getCanvPos(t);return!(s>this.canvas.width-this.params.margin.right)&&(!(i>this.canvas.height-this.params.margin.bottom)&&(this.last_xmove||(this.last_xmove=s),this.lastmouse_ymove||(this.lastmouse_ymove=i),!(Math.abs(i-this.lastmouse_ymove)<5&&Math.abs(s-this.last_xmove)<this.cndlwidth)&&void this.draw_cursor(s,i)))}pan_event(t,s=!1){let i,a,h;return[i,a]=s?this.getCanvPos({clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY}):this.getCanvPos(t),!(i>this.canvas.width-this.params.margin.right)&&(!(a>this.canvas.height-this.params.margin.bottom)&&(0!==this.chart_data.length&&(!(Math.abs(i-this.last_xmove)<9&&Math.abs(a-this.last_ymove)<9)&&(h=this.show_data.length<31?2:parseInt(this.show_data.length/10),this.last_xmove&&this.last_ymove?void(this.last_xmove<=i?(this.show_start=this.show_start-h<0?0:this.show_start-h,this.show_end=this.show_end-h<this.show_data.length?this.show_data.length:this.show_end-h,this.show_data=this.chart_data.slice(this.show_start,this.show_end),this.draw_cursor(i,a),this.last_xmove=i,this.last_ymove=a):this.last_xmove>i&&(this.show_end=this.show_end+h>this.chart_data.length?this.chart_data.length:this.show_end+h,this.show_end<this.chart_data.length-1&&(this.show_start=this.show_start+h<0?0:this.show_start+h),this.show_data=this.chart_data.slice(this.show_start,this.show_end),this.draw_cursor(i,a),this.last_xmove=i,this.last_ymove=a)):(this.last_xmove=i,this.last_ymove=a,!1)))))}scroll(t,s,i=!1){if(0===this.chart_data.length)return!1;let a,h=parseInt(.1*this.show_data.length);if(t<0?(a=this.show_start-(0===h?1:h),this.show_start=a>0?a:0,this.show_end=this.show_end+h>this.chart_data.length?this.chart_data.length:this.show_end+h):this.show_end-this.show_start>30&&(a=this.show_start+(0===h?1:h),this.show_start=a>0?a:0),this.show_data=this.chart_data.slice(this.show_start,this.show_end),this.draw(),!i){let[t,i]=this.getCanvPos(s);this.draw_cursor(t,i,!0)}}draw_x_axis(t){this.digitsFormat((this.params.end-this.params.begin)/9);let s,i=this.params.end-this.params.begin,a=t=>{let a=parseInt(i/t);a=parseInt(a/5)*t;let h=this.params.begin%a;for(s=0===h?this.params.begin:this.params.begin-h+a;s<this.params.end;){let t,h=new Date(1e3*s),e=this.params.margin.left+(s-this.params.begin)*this.params.cwr,r=15;this.ctx.strokeStyle=this.linecolor,this.ctx.textAlign="center",i<604800?"0:00"===(t=h.toLocaleTimeString().split(":").slice(0,2).join(":"))&&(t=String(h.getDate()).padStart(2,"0")+"."+String(parseInt(h.getMonth()+1)).padStart(2,"0"),r=25):t=String(h.getDate()).padStart(2,"0")+"."+String(parseInt(h.getMonth()+1)).padStart(2,"0"),this.ctx.font="12px Arial",this.ctx.fillText(t,e,this.canvas.height-this.params.margin.bottom+r),this.ctx.beginPath(),this.ctx.moveTo(e,this.canvas.height-this.params.margin.bottom),this.ctx.lineTo(e,this.canvas.height-this.params.margin.bottom+5),this.ctx.stroke(),s+=a}};i>259200?a(14400):i>86400?a(3600):i>3600&&a(3600)}draw_y_axis(){let t=(s,i=0)=>{let a;return s>10?(i++,(a=s/10)>10?t(a,i):i):s<1?(i--,(a=10*s)<.1?t(a,i):i):i},s=this.params.max-this.params.min,i=(i=>{let a=t(s),h=Math.pow(10,a),e=i/h;return e<.3?h/40:e<.5?h/25:e<1?h/10:e<2?h/5:e<3?h/2.5:e<5?h/2:h})(s),a=this.params.min-this.params.min%i+i;for(;a<this.params.max;){a=this.decimation_currency(a);let t=this.params.ch-this.params.margin.bottom-(a-this.params.min)*this.params.chr;this.ctx.strokeStyle=this.linecolor,this.ctx.beginPath(),this.ctx.moveTo(this.canvas.width-this.params.margin.right,t),this.ctx.lineTo(this.canvas.width-this.params.margin.right+5,t),this.ctx.font="12px Arial",this.ctx.fillText(a<1e-4?a.toFixed(8):a,this.canvas.width-this.params.margin.right+8,t+3),this.ctx.stroke(),a+=i}}draw_candle_and_vol(){let t=this.params.cw/(4*(this.show_data.length-1));t<.5?t=.5:t>5&&(t=5),this.cndlwidth=t,this.coords_of_candles=[],this.show_data.forEach(s=>{let i=this.params.ch-this.params.margin.bottom-(s.close-this.params.min)*this.params.chr,a=this.params.ch-this.params.margin.bottom-(s.low-this.params.min)*this.params.chr,h=this.params.ch-this.params.margin.bottom-(s.high-this.params.min)*this.params.chr,e=this.params.ch-this.params.margin.bottom-(s.open-this.params.min)*this.params.chr,r=(s.date-this.params.begin)*this.params.cwr+this.params.margin.left;i<e?(this.ctx.strokeStyle=this.growcolor,this.ctx.fillStyle=this.growcolor):(this.ctx.strokeStyle=this.fallcolor,this.ctx.fillStyle=this.fallcolor),this.ctx.beginPath(),e===i?(this.ctx.moveTo(r-t,e),this.ctx.lineTo(r+t,e),this.ctx.stroke()):(this.ctx.moveTo(r,a),this.ctx.lineTo(r,h),this.ctx.stroke(),this.ctx.moveTo(r,e),this.ctx.fillRect(r-t,e,2*t,i-e)),this.ctx.fillStyle="black",this.ctx.globalAlpha=.2,this.ctx.fillRect(r-t,this.canvas.height-this.params.margin.bottom,2*t,-this.params.cvr*s.vol),this.ctx.globalAlpha=1,this.coords_of_candles.push(r+t)})}draw_cursor(t,s,i=!1){if(i||this.draw(),!this.params)return!1;this.ctx.strokeStyle=this.cursorlinecolor,this.ctx.fillStyle=this.cursorlinecolor,this.ctx.moveTo(t,this.params.margin.top),this.ctx.lineTo(t,this.canvas.height-this.params.margin.bottom),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(this.params.margin.left,s),this.ctx.lineTo(this.canvas.width-this.params.margin.right,s),this.ctx.font="12px Arial",this.ctx.textAlign="left";let a=(this.params.ch-s-this.params.margin.bottom)/this.params.chr+this.params.min;this.ctx.fillRect(this.canvas.width-this.params.margin.right,s-10,80,20),this.ctx.fillStyle="#fefefe",this.ctx.fillText(this.digitsFormat(a),this.canvas.width-this.params.margin.right+8,s+4),this.ctx.stroke(),this.last_xmove=t,this.lastmouse_ymove=s,this.ctx.fillStyle=this.fontcolor;let h=this.getcandle(t);if(!h)return!1;this.ctx.fillText(new Date(parseInt(1e3*(this.params.begin+t/this.params.cwr))).toISOString().replace("T"," ").slice(0,16),this.params.margin.left,this.params.margin.top+15),this.ctx.fillText("V: "+this.digitsFormat(h.vol,"vol")+" "+this.currencypair[0],this.params.margin.left,this.params.margin.top+30),this.ctx.fillText("O: "+this.digitsFormat(h.open),this.canvas.width-this.params.margin.right-90,this.params.margin.top+15),this.ctx.fillText("H: "+this.digitsFormat(h.high),this.canvas.width-this.params.margin.right-90,this.params.margin.top+30),this.ctx.fillText("C: "+this.digitsFormat(h.close),this.canvas.width-this.params.margin.right-90,this.params.margin.top+45),this.ctx.fillText("L: "+this.digitsFormat(h.low),this.canvas.width-this.params.margin.right-90,this.params.margin.top+60)}draw(){if(0===this.chart_data.length)return!1;this.canvas.width=1*this.canvas.parentNode.clientWidth,this.canvas.height=1*this.canvas.parentNode.clientHeight;let t=this.canvas.width,s=this.canvas.height,i={top:20,bottom:30,left:5,right:80},a=i.top+i.bottom+10,h=i.left+i.right+10,[e,r,o]=this.getMaxMin(this.show_data),n=this.show_data[0].date,c=this.show_data[this.show_data.length-1].date,l=(s-a)/(r-e),m=(t-h)/(c-n),d=60/o;this.params={max:r,min:e,maxvol:o,chr:l,cwr:m,cvr:d,mpv:a,mph:h,margin:i,padding:5,ch:s,cw:t,end:c,begin:n},this.ctx.fillStyle=this.linecolor,this.ctx.font="14px Arial",this.ctx.fillText(this.currencypair.join("/"),i.left,i.top-5),this.ctx.beginPath(),this.ctx.strokeStyle=this.linecolor,this.ctx.moveTo(i.left,this.canvas.height-i.bottom),this.ctx.lineTo(this.canvas.width-i.right,this.canvas.height-i.bottom),this.ctx.lineTo(this.canvas.width-i.right,i.top),this.ctx.stroke(),this.draw_y_axis(),this.draw_x_axis(),this.draw_candle_and_vol()}getMaxMin(t){let s,i=0,a=0;return t.forEach(t=>{t.high>i&&(i=t.high),s?t.low<s&&(s=t.low):s=t.low,t.vol>a&&(a=t.vol)}),[s,i,a]}decimation_currency(t){return Math.floor(1e8*t)/1e8}getCanvPos(t){var s=this.canvas.getBoundingClientRect();return[(t.clientX-s.left)/(s.right-s.left)*this.canvas.width,(t.clientY-s.top)/(s.bottom-s.top)*this.canvas.height]}digitsFormat(t,s="rate"){return""===t?"":"summ"===s?Math.round(1e8*t)/1e8:"rate"===s?0===t?0:t>1e9?Math.floor(t):t>1e6?Math.floor(10*t)/10:t>999.99?Math.floor(100*t)/100:t>99.999?Math.floor(1e3*t)/1e3:t>9.9999?Math.floor(1e4*t)/1e4:t>.99999?Math.floor(1e4*t)/1e4:t>.0999999?Math.floor(1e5*t)/1e5:t>.009999999?Math.floor(1e6*t)/1e6:t>999999e-9?Math.floor(1e6*t)/1e6:t>99999e-9?Math.floor(1e7*t)/1e7:Number(t).toFixed(8):t>1e9?Math.round(t/1e9)+"mm":t>1e6?Math.round(t/1e6)+"m":t>1e3?Math.round(t/1e3)+"k":t>100?Math.round(10*t)/10:t>10?Math.round(100*t)/100:Math.round(1e3*t)/1e3}getcandle(t){for(let s=0;s<this.coords_of_candles.length;s++)if(this.coords_of_candles[s]>t)return this.show_data[s]}}
